#!/bin/bash
# This script configures nginx to run as the 'nginx' user on port 8080

# Step 1: Ensure nginx user exists
id nginx &>/dev/null || useradd --system --no-create-home --shell /usr/sbin/nologin nginx

# Step 2: Update the nginx config to run as nginx user and listen on port 8080
NGINX_CONF="/etc/nginx/nginx.conf"

# Backup original config
cp "$NGINX_CONF" "${NGINX_CONF}.bak"

# Set user to 'nginx'
sed -i 's/^user .*/user nginx;/' "$NGINX_CONF"

# Change listening port in all server blocks
find /etc/nginx/sites-available /etc/nginx/conf.d /etc/nginx/sites-enabled -type f -exec sed -i 's/listen 80 default_server;/listen 8080 default_server;/g' {} \;
find /etc/nginx/sites-available /etc/nginx/conf.d /etc/nginx/sites-enabled -type f -exec sed -i 's/listen 80;/listen 8080;/g' {} \;

# Default fallback: in case port 80 config is only in nginx.conf
sed -i 's/listen 80;/listen 8080;/g' "$NGINX_CONF"
sed -i 's/listen 80 default_server;/listen 8080 default_server;/g' "$NGINX_CONF"

# Step 3: Restart nginx to apply changes
service nginx restart
